define("pay_tt",function(a){"use strict";var e=a("common/widget/back_btn/main"),t=a("common/utility/index"),n=a("common/ua/index"),o=a("components/zepto/zepto.js"),s=a("components/fastclick/fastclick.js"),l=(a("yue_ui/frozen"),a("common/I_APP/I_APP")),i=a("coupon/list"),c=a("common/widget/yueyue_header/main"),r=a("common/widget/header/main");"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){s.attach(document.body)},!1),function(a,o){var s=a("#nav-header"),d=Handlebars.template(function(a,e,t,n,o){function s(a,e){var n,o,s="";return s+='\r\n<ul class="info ui-list ui-list-text pt15 pr15 pb5">\r\n	<li>\r\n		<p>商品名称：',(o=t.goods_name)?n=o.call(a,{hash:{},data:e}):(o=a&&a.goods_name,n=typeof o===d?o.call(a,{hash:{},data:e}):o),s+=p(n)+"</p>\r\n	</li>\r\n    <li>\r\n        <div>规格：",n=t["if"].call(a,a&&a.prices_spec,{hash:{},inverse:_.program(4,i,e),fn:_.program(2,l,e),data:e}),(n||0===n)&&(s+=n),s+="</div>\r\n    </li>\r\n    <li>\r\n        <div>全额：",(o=t.amount)?n=o.call(a,{hash:{},data:e}):(o=a&&a.amount,n=typeof o===d?o.call(a,{hash:{},data:e}):o),s+=p(n)+"</div>\r\n    </li>\r\n    <li>\r\n        <div>日期：",(o=t.service_time_str)?n=o.call(a,{hash:{},data:e}):(o=a&&a.service_time_str,n=typeof o===d?o.call(a,{hash:{},data:e}):o),s+=p(n)+"</div>\r\n    </li>\r\n</ul>\r\n"}function l(a,e){var n,o;return(o=t.prices_spec)?n=o.call(a,{hash:{},data:e}):(o=a&&a.prices_spec,n=typeof o===d?o.call(a,{hash:{},data:e}):o),p(n)}function i(){return"无"}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,a.helpers),o=o||{};var c,r="",d="function",p=this.escapeExpression,_=this;return r+='<div id="global-header"></div>\r\n\r\n',c=t.each.call(e,(c=e&&e.data,null==c||c===!1?c:c.detail_list),{hash:{},inverse:_.noop,fn:_.program(1,s,o),data:o}),(c||0===c)&&(r+=c),r+='\r\n\r\n\r\n\r\n<div class="mt30 pl15 mb10">应付金额</div>\r\n\r\n<!--支付模块-->\r\n<ul class="ui-list ui-list-text " class="ui-border-t">\r\n    <li class="ui-border-t">\r\n        <div class="ui-txt-default ">支付总价：<span >￥<label data-role="pay-amount">'+p((c=e&&e.data,c=null==c||c===!1?c:c.total_amount,typeof c===d?c.apply(e):c))+'</label></span></div>\r\n    </li>\r\n    <li data-role="coupon-money" class="ui-border-t">\r\n        <div class="ui-txt-default ">使用优惠券：<span><div class="ui-nowrap" style="width: 200px;" data-role="coupon-money-tag"></div></span></div>\r\n        <div class="ui-edge-right">\r\n            <span class="count-money-color" data-role="coupon-money-text"></span>\r\n            <i class="icon icon-select-no" data-role="yes-tag"></i>\r\n        </div>\r\n    </li>\r\n    <li data-role="select-available-balance" class="ui-border-t">\r\n		<div class="ui-txt-default ">钱包<span>（￥<label data-role="available_balance">'+p((c=e&&e.data,c=null==c||c===!1?c:c.available_balance,typeof c===d?c.apply(e):c))+'</label></span>）：<span class="count-money-color" data-role="less-money"></span></div>\r\n		<div class="ui-edge-right">\r\n\r\n			<i class="icon icon-select-no" data-role="yes-tag"></i>\r\n		</div>\r\n	</li>\r\n    <li class="ui-border-t">\r\n        <div class="ui-txt-default ">还需支付：<span class="count-money-color_v2 fb">￥<label data-role="need-price">'+p((c=e&&e.data,c=null==c||c===!1?c:c.pay_amount,typeof c===d?c.apply(e):c))+'</label></span></div>\r\n    </li>\r\n</ul>\r\n<ul class="ui-list ui-list-text ui-border-b mt20 fn-hide" style="margin-bottom: 0;"  data-role="must-pay-container"></ul>\r\n\r\n<div data-role="other-pay-container">\r\n    <div class="mt30 pl15 mb10">支付方式</div>\r\n    <ul class="ui-list ui-list-text " >\r\n        <li class="ui-border-t" data-pay-type="alipay_purse" data-role="pay-li">\r\n            <div class="ui-txt-default ">\r\n                <div class="pay-type">\r\n                    <i class="icon icon-zhifubao"></i>\r\n                    <div class="ui-list-info ">\r\n                        <h4 class="ui-nowrap" >支付宝支付</h4>\r\n                        <p class="ui-nowrap">推荐有支付宝账号的用户使用</p>\r\n                    </div>\r\n                </div>\r\n                <div class="ui-edge-right">\r\n                    <i class="icon icon-select-no" data-role="yes-tag"></i>\r\n                </div>\r\n            </div>\r\n        </li>\r\n        <li class="ui-border-t" data-pay-type="tenpay_wxapp" data-role="pay-li">\r\n            <div class="ui-txt-default ">\r\n                <div class="pay-type">\r\n                    <i class="icon icon-wx-pay"></i>\r\n                    <div class="ui-list-info ">\r\n                        <h4 class="ui-nowrap" >微信支付</h4>\r\n                        <p class="ui-nowrap">安装微信5.0及以上版本的使用</p>\r\n                    </div>\r\n                </div>\r\n                <div class="ui-edge-right">\r\n                    <i class="icon icon-select-no" data-role="yes-tag"></i>\r\n                </div>\r\n            </div>\r\n        </li>\r\n    </ul>\r\n\r\n    <div style="height:100px;" class="bg"></div>\r\n\r\n</div>\r\n\r\n\r\n\r\n\r\n<div class="last-container fn-hide"></div>\r\n<!--支付模块-->\r\n<div class="buttom-btn-wrap ui-border-t">\r\n    <div class="pl10 text-info">\r\n        还需支付：<span class="count-money-color_v2 red-font" style="font-size: 18px;">￥<label data-role="need-price">'+p((c=e&&e.data,c=null==c||c===!1?c:c.pay_amount,typeof c===d?c.apply(e):c))+'</label></span>\r\n    </div>\r\n    <div class="right">\r\n        <button class="ui-tt-pay-btn " id="pay-btn">\r\n            <span class="ui-button-content" ><i class="icon icon-btn-icon-fk "></i></span>\r\n            <span class="txt">去支付</span>\r\n        </button>\r\n    </div>\r\n\r\n</div>'}),p={};p.order_sn=a("#order_sn").val(),p.$page_container=a('[data-role="page-container"]'),l.isPaiApp;var _=function(){var a=this;a.init()};_.prototype={refresh:function(){var e=this,n=a.loading({content:"加载中..."});t.ajax_request({url:o.$__config.ajax_url.get_tt_pay_info,data:{order_sn:p.order_sn},success:function(t){var o=t.result_data;p.$page_container.html(""),p.$page_container.html(d(o)),o.request_id&&(p.request_id=o.request_id),o.total_amount&&(p.order_total_amount=o.total_amount),o.pay_amount&&(p.order_pay_amount=o.pay_amount),p.coupon_obj=i.init({container:a('[data-role="coupon-list-container"]'),order_sn:p.order_sn,order_total_amount:p.order_total_amount,order_pay_amount:p.order_pay_amount,page:1,extend_params:{module_type:"mall_order"}}),r.init({ele:a("#global-header"),title:"支付",header_show:!0,right_icon_show:!1,share_icon:{show:!1,content:""},omit_icon:{show:!1,content:""},show_txt:{show:!1,content:"编辑"}}),e.setup_event(),n.loading("hide")},error:function(){n.loading("hide"),a.tips({content:"网络异常",stayTime:3e3,type:"warn"})}})},page_back:function(){},init:function(){var a=this,t=e.render();s.prepend(t),a.setup_back()},hide:function(){},setup_back:function(){a('[data-role="page-back"]').on("tap",function(){l.isPaiApp&&l.app_back()})},setup_event:function(){var e=this;p.$pay_li=a('[data-role="pay-li"]'),p.$pay_btn=a("#pay-btn"),p.$select_ab_btn=a('[data-role="select-available-balance"]'),p.$less_money=a('[data-role="less-money"]'),p.$available_balance=a('[data-role="available_balance"]'),p.$need_price=a('[data-role="need-price"]'),p.ab=a('[data-role="available_balance"]').html(),p.total_price=a('[data-role="pay-amount"]').html(),p.$coupon_list_wrap=a('[data-role="coupon-list-wrap"]'),p.$coupon_money=a('[data-role="coupon-money"]'),p.$coupon_money_tag=a('[data-role="coupon-money-tag"]'),p.$coupon_money_text=a('[data-role="coupon-money-text"]'),c.render(a('[data-role="nav-header"]')[0],{left_text:"返回",title:"可用优惠券",right_text:"确定"}),p.$left_btn=a('[data-role="left-btn"]'),p.$right_btn=a('[data-role="right-btn"]'),p.selected_pay_action_type="alipay_purse",p.can_use_balance=!0,p.$select_ab_btn.on("click",function(t){var n=a(t.currentTarget),o=n.find('[data-role="yes-tag"]'),s=o.hasClass("icon-select-active");s?o.addClass("icon-select-no").removeClass("icon-select-active"):o.removeClass("icon-select-no").addClass("icon-select-active"),p.can_use_balance=o.hasClass("icon-select-active");var l={can_use_balance:p.can_use_balance,available_balance:p.ab,total_price:p.total_price,coupon:p.coupon_obj.selected_coupon&&p.coupon_obj.selected_coupon.face_value};e.count_money(l)}),p.$pay_li.on("click",function(e){{var t=a(e.currentTarget),n=t.find('[data-role="yes-tag"]');n.hasClass("icon-select-active")}p.$pay_li.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.addClass("icon-select-active").removeClass("icon-select-no");var o=t.attr("data-pay-type");p.selected_pay_action_type=o,p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active"),p.can_use_balance&&p.$select_ab_btn.find('[data-role="yes-tag"]').addClass("icon-select-active")}),p.$left_btn.on("click",function(){p.$page_container.removeClass("fn-hide"),p.$coupon_list_wrap.addClass("fn-hide"),n.is_yue_app||a("main").css("padding-top","45px")}),p.$right_btn.on("click",function(){p.$page_container.removeClass("fn-hide"),p.$coupon_list_wrap.addClass("fn-hide");var t=p.coupon_obj.selected_coupon,o={can_use_balance:p.can_use_balance,available_balance:p.ab,total_price:p.total_price,set_pay_type:!1,coupon:t&&t.face_value};e.count_money(o),t&&p.$coupon_money_tag.html(t.batch_name),t?p.$coupon_money.find('[data-role="yes-tag"]').addClass("icon-select-active").removeClass("icon-select-no"):p.$coupon_money.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.is_yue_app||a("main").css("padding-top","45px")}),p.$coupon_money.on("click",function(){p.$page_container.addClass("fn-hide"),p.$coupon_list_wrap.removeClass("fn-hide"),n.is_yue_app||a("main").css("padding-top",0)}),p.$pay_btn.on("click",function(){if(!p.selected_pay_action_type)return void alert("请选择支付方式");if(confirm("确认支付?")){var n=o.location.href.replace("pay.php","success.php"),s={third_code:p.selected_pay_action_type,order_sn:p.order_sn,redirect_url:n,coupon_sn:p.coupon_obj.selected_coupon&&p.coupon_obj.selected_coupon.coupon_sn||"",available_balance:p.ab,is_available_balance:p.$select_ab_btn.find('[data-role="yes-tag"]').hasClass("icon-select-active")?1:0};if(a("#submit_token").val())return void(o.location.href="../notice/index.php?type=pay");e.pay_action(s,{success:function(n){var s=n.result_data&&n.result_data.third_code,i="success.php?order_sn="+n.result_data.order_sn,c=n.result_data&&n.result_data.result;if(1==c)switch(s){case"alipay_purse":l.alipay({alipayparams:n.result_data.request_data,payment_no:n.result_data.payment_no},function(n){var s=t.int(n.result),l=e.after_pay_text(s);a.tips({content:l,stayTime:3e3,type:"success"}),(1==s||-1==s||-2==s)&&(a("#submit_token").val((new Date).getTime()),o.location.href=i)});break;case"tenpay_wxapp":l.wxpay(JSON.parse(n.result_data.request_data),function(n){var s=t.int(n.result),l=e.after_pay_text(s);a.tips({content:l,stayTime:3e3,type:"success"}),(1==s||-1==s||-2==s)&&(a("#submit_token").val((new Date).getTime()),o.location.href=i)})}else a.tips({content:"余额支付成功",stayTime:3e3,type:"success"}),a("#submit_token").val((new Date).getTime()),o.location.href=i},error:function(){}})}});var s={can_use_balance:p.ab>0?!0:!1,available_balance:p.ab,total_price:p.total_price};e.count_money(s)},count_money:function(e){var n=this,o=t.float(e.total_price),s=t.float(e.available_balance),l=null==e.set_pay_type?!0:!1,i=e.coupon||0,c=0;i&&(o-=t.float(i));var r=s-o;e.can_use_balance?(c=r,0>=c?c=s:(c=o,r=0),p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"),r>=0?(n.clear_select(),n.control_other_pay_item({show:!1}),console.log("余额完全够钱支付了订单")):(n.control_other_pay_item({show:!0}),l&&a('[data-pay-type="'+p.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"))):(r=o,n.clear_select(!0),n.control_other_pay_item({show:!0}),l&&a('[data-pay-type="'+p.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active")),n.must_pay_money=t.format_float(r,2),n.must_pay_money<0&&(n.must_pay_money=-1*n.must_pay_money),p.$need_price.html(n.must_pay_money),p.$less_money.html("-￥"+c),p.$coupon_money_text.html(i?"-￥"+i:"")},pay_action:function(e,n){var s=a.loading({content:"发送中..."});t.ajax_request({url:o.$__config.ajax_url.pay_tt_action,data:e,type:"POST",success:function(e){if(s.loading("hide"),e.result_data&&e.result_data.result>0){n.success.call(this,e);var t="success"}else{var t="warn";a.tips({content:e.result_data.message,stayTime:3e3,type:t})}},error:function(){n.error.call(this),s.loading("hide"),a.tips({content:"网络异常",stayTime:3e3,type:"warn"})}})},clear_select:function(a){var e=p.$pay_li.find('[data-role="yes-tag"]');a?p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"):e.removeClass("icon-select-active").addClass("icon-select-no")},control_other_pay_item:function(e){e.show?(a('[data-role="other-pay-container"]').removeClass("fn-hide"),a('[data-role="must-pay-container"]').removeClass("last-sec-container")):(a('[data-role="other-pay-container"]').addClass("fn-hide"),a('[data-role="must-pay-container"]').addClass("last-sec-container"))},after_pay_text:function(a){var e="";switch(t.int(a)){case 1:case-2:case-1:e="支付成功";break;case 0:e="其它错误";break;case-3:e="支付失败";break;case-4:e="支付取消"}return e}};var u=new _;u.refresh()}(o,window)});