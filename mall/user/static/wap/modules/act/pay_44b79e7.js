define("act/pay",function(a){"use strict";var e=a("common/widget/back_btn/main"),t=a("common/utility/index"),n=a("common/ua/index"),i=a("components/zepto/zepto.js"),l=a("components/fastclick/fastclick.js"),o=(a("yue_ui/frozen"),a("common/I_APP/I_APP")),s=a("coupon/list"),c=a("common/widget/yueyue_header/main"),p=a("common/widget/header/main");"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){l.attach(document.body)},!1),function(a,i){var l=a("#nav-header"),d=Handlebars.template(function(a,e,t,n,i){function l(){return'\n                <li class="ui-border-t" data-pay-type="alipay_purse" data-role="pay-li">\n                    <div class="ui-txt-default ">\n                        <div class="pay-type">\n                            <i class="icon icon-zhifubao"></i>\n                            <div class="ui-list-info ">\n                                <h4 class="ui-nowrap" >支付宝支付</h4>\n                                <p class="ui-nowrap">推荐有支付宝账号的用户使用</p>\n                            </div>\n                        </div>\n                        <div class="ui-edge-right">\n                            <i class="icon icon-select-no" data-role="yes-tag"></i>\n                        </div>\n                    </div>\n                </li>\n                <li class="ui-border-t" data-pay-type="tenpay_wxapp" data-role="pay-li">\n                    <div class="ui-txt-default ">\n                        <div class="pay-type">\n                            <i class="icon icon-wx-pay"></i>\n                            <div class="ui-list-info ">\n                                <h4 class="ui-nowrap" >微信支付</h4>\n                                <p class="ui-nowrap">安装微信5.0及以上版本的使用</p>\n                            </div>\n                        </div>\n                        <div class="ui-edge-right">\n                            <i class="icon icon-select-no" data-role="yes-tag"></i>\n                        </div>\n                    </div>\n                </li>\n            '}function o(){return'\n                <li class="ui-border-t" data-pay-type="tenpay_wxpub" data-role="pay-li">\n                    <div class="ui-txt-default ">\n                        <div class="pay-type">\n                            <i class="icon icon-wx-pay"></i>\n                            <div class="ui-list-info ">\n                                <h4 class="ui-nowrap" >微信支付</h4>\n                                <p class="ui-nowrap">安装微信5.0及以上版本的使用</p>\n                            </div>\n                        </div>\n                        <div class="ui-edge-right">\n                            <i class="icon icon-select-no" data-role="yes-tag"></i>\n                        </div>\n                    </div>\n                </li>\n            '}function s(){return'\n                <li class="ui-border-t" data-pay-type="alipay_wap" data-role="pay-li">\n                    <div class="ui-txt-default ">\n                        <div class="pay-type">\n                            <i class="icon icon-zhifubao"></i>\n                            <div class="ui-list-info ">\n                                <h4 class="ui-nowrap" >支付宝支付</h4>\n                                <p class="ui-nowrap">推荐有支付宝账号的用户使用</p>\n                            </div>\n                        </div>\n                        <div class="ui-edge-right">\n                            <i class="icon icon-select-no" data-role="yes-tag"></i>\n                        </div>\n                    </div>\n                </li>\n            '}this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,a.helpers),i=i||{};var c,p="",d="function",r=this.escapeExpression,_=this;return p+='<div style="padding-bottom: 55px">\n    <div id="global-header"></div>\n\n    <ul class="info ui-list ui-list-text pt15 pr15 pb5">\n        <li>\n            <p>活动名称：'+r((c=e&&e.data,c=null==c||c===!1?c:c.detail_list,c=null==c||c===!1?c:c.event_title,typeof c===d?c.apply(e):c))+"</p>\n        </li>\n        <li>\n            <div>手机号码："+r((c=e&&e.data,c=null==c||c===!1?c:c.detail_list,c=null==c||c===!1?c:c.phone,typeof c===d?c.apply(e):c))+"</div>\n        </li>\n        <li>\n            <div>活动价格：￥"+r((c=e&&e.data,c=null==c||c===!1?c:c.detail_list,c=null==c||c===!1?c:c.total_budget,typeof c===d?c.apply(e):c))+"</div>\n        </li>\n        <li>\n            <div>报名人数："+r((c=e&&e.data,c=null==c||c===!1?c:c.detail_list,c=null==c||c===!1?c:c.enroll_num,typeof c===d?c.apply(e):c))+"</div>\n        </li>\n        <li>\n            <div>选择场次："+r((c=e&&e.data,c=null==c||c===!1?c:c.detail_list,c=null==c||c===!1?c:c.table_text,typeof c===d?c.apply(e):c))+'</div>\n        </li>\n    </ul>\n\n\n\n\n    <div class="mt30 pl15 mb10">应付金额</div>\n\n    <!--支付模块-->\n    <ul class="ui-list ui-list-text " class="ui-border-t">\n        <li class="ui-border-t">\n            <div class="ui-txt-default ">支付总价：<span >￥<label data-role="pay-amount">'+r((c=e&&e.data,c=null==c||c===!1?c:c.total_amount,typeof c===d?c.apply(e):c))+'</label></span></div>\n        </li>\n        <li data-role="coupon-money" class="ui-border-t">\n            <div class="ui-txt-default ">使用优惠券：<span><div class="ui-nowrap" style="width: 200px;" data-role="coupon-money-tag"></div></span></div>\n            <div class="ui-edge-right">\n                <span class="count-money-color" data-role="coupon-money-text"></span>\n                <i class="icon icon-select-no" data-role="yes-tag"></i>\n            </div>\n        </li>\n        <li data-role="select-available-balance" class="ui-border-t">\n            <div class="ui-txt-default ">钱包<span>（￥<label data-role="available_balance">'+r((c=e&&e.data,c=null==c||c===!1?c:c.available_balance,typeof c===d?c.apply(e):c))+'</label></span>）：<span class="count-money-color" data-role="less-money"></span></div>\n            <div class="ui-edge-right">\n\n                <i class="icon icon-select-no" data-role="yes-tag"></i>\n            </div>\n        </li>\n        <li class="ui-border-t">\n            <div class="ui-txt-default ">还需支付：<span class="count-money-color_v2 fb">￥<label data-role="need-price">'+r((c=e&&e.data,c=null==c||c===!1?c:c.pay_amount,typeof c===d?c.apply(e):c))+'</label></span></div>\n        </li>\n    </ul>\n    <ul class="ui-list ui-list-text ui-border-b mt20 fn-hide" style="margin-bottom: 0;"  data-role="must-pay-container"></ul>\n\n    <div data-role="other-pay-container">\n        <div class="mt30 pl15 mb10">支付方式</div>\n        <ul class="ui-list ui-list-text " >\n            ',c=t["if"].call(e,(c=e&&e.data,null==c||c===!1?c:c.is_yueyue_app),{hash:{},inverse:_.noop,fn:_.program(1,l,i),data:i}),(c||0===c)&&(p+=c),p+="\n            ",c=t["if"].call(e,(c=e&&e.data,null==c||c===!1?c:c.is_weixin),{hash:{},inverse:_.program(5,s,i),fn:_.program(3,o,i),data:i}),(c||0===c)&&(p+=c),p+='\n        </ul>\n\n        <div style="height:55px;" class="bg"></div>\n\n    </div>\n\n\n\n\n    <div class="last-container fn-hide"></div>\n    <!--支付模块-->\n    <div class="buttom-btn-wrap ui-border-t">\n        <div class="pl10 text-info">\n            还需支付：<span class="count-money-color_v2 red-font" style="font-size: 18px;">￥<label data-role="need-price">'+r((c=e&&e.data,c=null==c||c===!1?c:c.pay_amount,typeof c===d?c.apply(e):c))+'</label></span>\n        </div>\n        <div class="right">\n            <button class="ui-tt-pay-btn " id="pay-btn">\n                <span class="ui-button-content" ><i class="icon icon-btn-icon-fk "></i></span>\n                <span class="txt">去支付</span>\n            </button>\n        </div>\n\n    </div>\n</div>'}),r={};r.order_sn=a("#order_sn").val(),r.$page_container=a('[data-role="page-container"]'),o.isPaiApp&&o.showtopmenu(!1);var _=function(){var a=this;a.init()};_.prototype={refresh:function(){var e=this,t=a.loading({content:"加载中..."}),n=_page_data.result_data;r.$page_container.html(""),r.$page_container.html(d({data:n})),r.page_params=i._page_params.result_data,r.coupon_obj=s.init({container:a('[data-role="coupon-list-container"]'),order_total_amount:n.total_amount,extend_params:{event_id:r.page_params.event_id,enroll_id:r.page_params.enroll_id,table_id:r.page_params.table_id,module_type:"waipai"},page:1}),p.init({ele:a("#global-header"),title:"支付",header_show:!0,right_icon_show:!1,share_icon:{show:!1,content:""},omit_icon:{show:!1,content:""},show_txt:{show:!1,content:"编辑"}}),e.setup_event(),t.loading("hide")},page_back:function(){},init:function(){var a=this,t=e.render();l.prepend(t),a.setup_back()},hide:function(){},setup_back:function(){a('[data-role="page-back"]').on("tap",function(){o.isPaiApp&&o.app_back()})},setup_event:function(){var e=this;r.$pay_li=a('[data-role="pay-li"]'),r.$pay_btn=a("#pay-btn"),r.$select_ab_btn=a('[data-role="select-available-balance"]'),r.$less_money=a('[data-role="less-money"]'),r.$available_balance=a('[data-role="available_balance"]'),r.$need_price=a('[data-role="need-price"]'),r.ab=a('[data-role="available_balance"]').html(),r.total_price=a('[data-role="pay-amount"]').html(),r.$coupon_list_wrap=a('[data-role="coupon-list-wrap"]'),r.$coupon_money=a('[data-role="coupon-money"]'),r.$coupon_money_tag=a('[data-role="coupon-money-tag"]'),r.$coupon_money_text=a('[data-role="coupon-money-text"]'),c.render(a('[data-role="nav-header"]')[0],{left_text:"返回",title:"可用优惠券",right_text:"确定"}),r.$left_btn=a('[data-role="left-btn"]'),r.$right_btn=a('[data-role="right-btn"]');var l=i.location;l.origin||(l.origin=l.protocol+"//"+l.hostname+(l.port?":"+l.port:"")),r.selected_pay_action_type=o.isPaiApp?"alipay_purse":n.is_weixin?"tenpay_wxpub":"alipay_wap",r.can_use_balance=!0,r.$select_ab_btn.on("click",function(t){var n=a(t.currentTarget),i=n.find('[data-role="yes-tag"]'),l=i.hasClass("icon-select-active");l?i.addClass("icon-select-no").removeClass("icon-select-active"):i.removeClass("icon-select-no").addClass("icon-select-active"),r.can_use_balance=i.hasClass("icon-select-active");var o={can_use_balance:r.can_use_balance,available_balance:r.ab,total_price:r.total_price,coupon:r.coupon_obj.selected_coupon&&r.coupon_obj.selected_coupon.face_value};e.count_money(o)}),r.$pay_li.on("click",function(e){{var t=a(e.currentTarget),n=t.find('[data-role="yes-tag"]');n.hasClass("icon-select-active")}r.$pay_li.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.addClass("icon-select-active").removeClass("icon-select-no");var i=t.attr("data-pay-type");r.selected_pay_action_type=i,r.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active"),r.can_use_balance&&r.$select_ab_btn.find('[data-role="yes-tag"]').addClass("icon-select-active")}),r.$left_btn.on("click",function(){r.$page_container.removeClass("fn-hide"),r.$coupon_list_wrap.addClass("fn-hide"),n.is_yue_app||a("main").css("padding-top","45px")}),r.$right_btn.on("click",function(){r.$page_container.removeClass("fn-hide"),r.$coupon_list_wrap.addClass("fn-hide");var t=r.coupon_obj.selected_coupon,i={can_use_balance:r.can_use_balance,available_balance:r.ab,total_price:r.total_price,set_pay_type:!1,coupon:t&&t.face_value};e.count_money(i),t&&r.$coupon_money_tag.html(t.batch_name),t?r.$coupon_money.find('[data-role="yes-tag"]').addClass("icon-select-active").removeClass("icon-select-no"):r.$coupon_money.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.is_yue_app||a("main").css("padding-top","45px")}),r.$coupon_money.on("click",function(){r.$page_container.addClass("fn-hide"),r.$coupon_list_wrap.removeClass("fn-hide"),n.is_yue_app||a("main").css("padding-top",0)}),r.$pay_btn.on("click",function(){if(!r.selected_pay_action_type)return void alert("请选择支付方式");if(confirm("确认支付?")){var n="./sign.php?event_id="+_page_params.result_data.event_id,s={third_code:r.selected_pay_action_type,redirect_url:n,coupon_sn:r.coupon_obj.selected_coupon&&r.coupon_obj.selected_coupon.coupon_sn||"",available_balance:r.ab,is_available_balance:r.$select_ab_btn.find('[data-role="yes-tag"]').hasClass("icon-select-active")?1:0};if(s=a.extend({},s,_page_params.result_data,!0),"tenpay_wxpub"==r.selected_pay_action_type){var c=s;delete c.redirect_url;var p=l.pathname.split("/");return p.pop(),p=p.join("/"),c.redirect_url=l.origin+p+"/sign.php?event_id="+_page_params.result_data.event_id,c=a.extend(c,{type:"waipai"}),c=a.param(c),void(i.location.href="http://yp.yueus.com/m/pay_jump_v2.php?"+c)}if("alipay_wap"==r.selected_pay_action_type){var p=l.pathname.split("/");p.pop(),p=p.join("/"),s.redirect_url=l.origin+p+"/sign.php?event_id="+_page_params.result_data.event_id}e.pay_action(s,{success:function(n){var l=n.result_data&&n.result_data.third_code,s=n.result_data&&n.result_data.channel_return,c=n.result_data&&n.result_data.code;if(2==c)switch(l){case"alipay_purse":o.alipay({alipayparams:n.result_data.data,payment_no:n.result_data.payment_no},function(n){var l=t.int(n.result),o=e.after_pay_text(l);a.tips({content:o,stayTime:3e3,type:"success"}),(1==l||-1==l||-2==l)&&(i.location.href=s)});break;case"tenpay_wxapp":o.wxpay(JSON.parse(n.result_data.data),function(n){var l=t.int(n.result),o=e.after_pay_text(l);a.tips({content:o,stayTime:3e3,type:"success"}),(1==l||-1==l||-2==l)&&(i.location.href=s)});break;case"alipay_wap":if(n.result_data.payment_no)i.location.href=n.result_data.data;else{var p=e.after_pay_text(c);a.tips({content:p,stayTime:3e3,type:"warn"})}}else a.tips({content:"余额支付成功",stayTime:3e3,type:"success"}),i.location.href=s},error:function(){}})}});var s={can_use_balance:r.ab>0?!0:!1,available_balance:r.ab,total_price:r.total_price};e.count_money(s)},count_money:function(e){var n=this,i=t.float(e.total_price),l=t.float(e.available_balance),o=null==e.set_pay_type?!0:!1,s=e.coupon||0,c=0;s&&(i-=t.float(s));var p=l-i;e.can_use_balance?(c=p,0>=c?c=l:(c=i,p=0),r.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"),p>=0?(n.clear_select(),n.control_other_pay_item({show:!1}),console.log("余额完全够钱支付了订单")):(n.control_other_pay_item({show:!0}),o&&a('[data-pay-type="'+r.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"))):(p=i,n.clear_select(!0),n.control_other_pay_item({show:!0}),o&&a('[data-pay-type="'+r.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active")),n.must_pay_money=t.format_float(p,2),n.must_pay_money<0&&(n.must_pay_money=-1*n.must_pay_money),r.$need_price.html(n.must_pay_money),r.$less_money.html("-￥"+c),r.$coupon_money_text.html(s?"-￥"+s:"")},pay_action:function(e,n){var l=a.loading({content:"发送中..."}),o="join_again_act.php";t.ajax_request({url:i.$__ajax_domain+o,data:e,type:"POST",success:function(e){if(l.loading("hide"),e.result_data&&e.result_data.code>0){n.success.call(this,e);var t="success"}else{var t="warn";a.tips({content:e.result_data.message,stayTime:3e3,type:t})}},error:function(){n.error.call(this),l.loading("hide"),a.tips({content:"网络异常",stayTime:3e3,type:"warn"})}})},clear_select:function(a){var e=r.$pay_li.find('[data-role="yes-tag"]');a?r.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"):e.removeClass("icon-select-active").addClass("icon-select-no")},control_other_pay_item:function(e){e.show?(a('[data-role="other-pay-container"]').removeClass("fn-hide"),a('[data-role="must-pay-container"]').removeClass("last-sec-container")):(a('[data-role="other-pay-container"]').addClass("fn-hide"),a('[data-role="must-pay-container"]').addClass("last-sec-container"))},after_pay_text:function(a){var e="";switch(t.int(a)){case 1:case-2:case-1:e="支付成功";break;case 0:e="其它错误";break;case-3:e="支付失败";break;case-4:e="支付取消"}return e}};var u=new _;u.refresh()}(i,window)});