define("act/pay",function(a){"use strict";var e=a("common/widget/back_btn/main"),t=a("common/utility/index"),n=a("common/ua/index"),l=a("components/zepto/zepto.js"),o=a("components/fastclick/fastclick.js"),i=(a("yue_ui/frozen"),a("common/I_APP/I_APP")),s=a("coupon/list"),c=a("common/widget/yueyue_header/main"),d=a("common/widget/header/main");"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){o.attach(document.body)},!1),function(a,l){var o=a("#nav-header"),r=Handlebars.template(function(a,e,t,n,l){this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,a.helpers),l=l||{};var o,i="",s="function",c=this.escapeExpression;return i+='<div id="global-header"></div>\n\n<ul class="info ui-list ui-list-text pt15 pr15 pb5">\n    <li>\n        <p>活动名称：'+c((o=e&&e.data,o=null==o||o===!1?o:o.detail_list,o=null==o||o===!1?o:o.event_title,typeof o===s?o.apply(e):o))+"</p>\n    </li>\n    <li>\n        <div>手机号码："+c((o=e&&e.data,o=null==o||o===!1?o:o.detail_list,o=null==o||o===!1?o:o.phone,typeof o===s?o.apply(e):o))+"</div>\n    </li>\n    <li>\n        <div>活动价格：￥"+c((o=e&&e.data,o=null==o||o===!1?o:o.detail_list,o=null==o||o===!1?o:o.total_budget,typeof o===s?o.apply(e):o))+"</div>\n    </li>\n    <li>\n        <div>报名人数："+c((o=e&&e.data,o=null==o||o===!1?o:o.detail_list,o=null==o||o===!1?o:o.enroll_num,typeof o===s?o.apply(e):o))+"</div>\n    </li>\n    <li>\n        <div>选择场次："+c((o=e&&e.data,o=null==o||o===!1?o:o.detail_list,o=null==o||o===!1?o:o.table_text,typeof o===s?o.apply(e):o))+'</div>\n    </li>\n</ul>\n\n\n\n\n<div class="mt30 pl15 mb10">应付金额</div>\n\n<!--支付模块-->\n<ul class="ui-list ui-list-text " class="ui-border-t">\n    <li class="ui-border-t">\n        <div class="ui-txt-default ">支付总价：<span >￥<label data-role="pay-amount">'+c((o=e&&e.data,o=null==o||o===!1?o:o.total_amount,typeof o===s?o.apply(e):o))+'</label></span></div>\n    </li>\n    <li data-role="coupon-money" class="ui-border-t">\n        <div class="ui-txt-default ">使用优惠券：<span><div class="ui-nowrap" style="width: 200px;" data-role="coupon-money-tag"></div></span></div>\n        <div class="ui-edge-right">\n            <span class="count-money-color" data-role="coupon-money-text"></span>\n            <i class="icon icon-select-no" data-role="yes-tag"></i>\n        </div>\n    </li>\n    <li data-role="select-available-balance" class="ui-border-t">\n        <div class="ui-txt-default ">钱包<span>（￥<label data-role="available_balance">'+c((o=e&&e.data,o=null==o||o===!1?o:o.available_balance,typeof o===s?o.apply(e):o))+'</label></span>）：<span class="count-money-color" data-role="less-money"></span></div>\n        <div class="ui-edge-right">\n\n            <i class="icon icon-select-no" data-role="yes-tag"></i>\n        </div>\n    </li>\n    <li class="ui-border-t">\n        <div class="ui-txt-default ">还需支付：<span class="count-money-color_v2 fb">￥<label data-role="need-price">'+c((o=e&&e.data,o=null==o||o===!1?o:o.pay_amount,typeof o===s?o.apply(e):o))+'</label></span></div>\n    </li>\n</ul>\n<ul class="ui-list ui-list-text ui-border-b mt20 fn-hide" style="margin-bottom: 0;"  data-role="must-pay-container"></ul>\n\n<div data-role="other-pay-container">\n    <div class="mt30 pl15 mb10">支付方式</div>\n    <ul class="ui-list ui-list-text " >\n        <li class="ui-border-t" data-pay-type="alipay_purse" data-role="pay-li">\n            <div class="ui-txt-default ">\n                <div class="pay-type">\n                    <i class="icon icon-zhifubao"></i>\n                    <div class="ui-list-info ">\n                        <h4 class="ui-nowrap" >支付宝支付</h4>\n                        <p class="ui-nowrap">推荐有支付宝账号的用户使用</p>\n                    </div>\n                </div>\n                <div class="ui-edge-right">\n                    <i class="icon icon-select-no" data-role="yes-tag"></i>\n                </div>\n            </div>\n        </li>\n        <li class="ui-border-t" data-pay-type="tenpay_wxapp" data-role="pay-li">\n            <div class="ui-txt-default ">\n                <div class="pay-type">\n                    <i class="icon icon-wx-pay"></i>\n                    <div class="ui-list-info ">\n                        <h4 class="ui-nowrap" >微信支付</h4>\n                        <p class="ui-nowrap">安装微信5.0及以上版本的使用</p>\n                    </div>\n                </div>\n                <div class="ui-edge-right">\n                    <i class="icon icon-select-no" data-role="yes-tag"></i>\n                </div>\n            </div>\n        </li>\n    </ul>\n\n    <div style="height:100px;" class="bg"></div>\n\n</div>\n\n\n\n\n<div class="last-container fn-hide"></div>\n<!--支付模块-->\n<div class="buttom-btn-wrap ui-border-t">\n    <div class="pl10 text-info">\n        还需支付：<span class="count-money-color_v2 red-font" style="font-size: 18px;">￥<label data-role="need-price">'+c((o=e&&e.data,o=null==o||o===!1?o:o.pay_amount,typeof o===s?o.apply(e):o))+'</label></span>\n    </div>\n    <div class="right">\n        <button class="ui-tt-pay-btn " id="pay-btn">\n            <span class="ui-button-content" ><i class="icon icon-btn-icon-fk "></i></span>\n            <span class="txt">去支付</span>\n        </button>\n    </div>\n\n</div>'}),p={};p.order_sn=a("#order_sn").val(),p.$page_container=a('[data-role="page-container"]'),i.isPaiApp;var _=function(){var a=this;a.init()};_.prototype={refresh:function(){var e=this,t=a.loading({content:"加载中..."}),n=_page_data.result_data;p.$page_container.html(""),p.$page_container.html(r({data:n})),p.page_params=l._page_params.result_data,p.coupon_obj=s.init({container:a('[data-role="coupon-list-container"]'),order_total_amount:n.total_amount,extend_params:{event_id:p.page_params.event_id,enroll_id:p.page_params.enroll_id,table_id:p.page_params.table_id,module_type:"waipai"},page:1}),d.init({ele:a("#global-header"),title:"支付",header_show:!0,right_icon_show:!1,share_icon:{show:!1,content:""},omit_icon:{show:!1,content:""},show_txt:{show:!1,content:"编辑"}}),e.setup_event(),t.loading("hide")},page_back:function(){},init:function(){var a=this,t=e.render();o.prepend(t),a.setup_back()},hide:function(){},setup_back:function(){a('[data-role="page-back"]').on("tap",function(){i.isPaiApp&&i.app_back()})},setup_event:function(){var e=this;p.$pay_li=a('[data-role="pay-li"]'),p.$pay_btn=a("#pay-btn"),p.$select_ab_btn=a('[data-role="select-available-balance"]'),p.$less_money=a('[data-role="less-money"]'),p.$available_balance=a('[data-role="available_balance"]'),p.$need_price=a('[data-role="need-price"]'),p.ab=a('[data-role="available_balance"]').html(),p.total_price=a('[data-role="pay-amount"]').html(),p.$coupon_list_wrap=a('[data-role="coupon-list-wrap"]'),p.$coupon_money=a('[data-role="coupon-money"]'),p.$coupon_money_tag=a('[data-role="coupon-money-tag"]'),p.$coupon_money_text=a('[data-role="coupon-money-text"]'),c.render(a('[data-role="nav-header"]')[0],{left_text:"返回",title:"可用优惠券",right_text:"确定"}),p.$left_btn=a('[data-role="left-btn"]'),p.$right_btn=a('[data-role="right-btn"]'),p.selected_pay_action_type="alipay_purse",p.can_use_balance=!0,p.$select_ab_btn.on("click",function(t){var n=a(t.currentTarget),l=n.find('[data-role="yes-tag"]'),o=l.hasClass("icon-select-active");o?l.addClass("icon-select-no").removeClass("icon-select-active"):l.removeClass("icon-select-no").addClass("icon-select-active"),p.can_use_balance=l.hasClass("icon-select-active");var i={can_use_balance:p.can_use_balance,available_balance:p.ab,total_price:p.total_price,coupon:p.coupon_obj.selected_coupon&&p.coupon_obj.selected_coupon.face_value};e.count_money(i)}),p.$pay_li.on("click",function(e){{var t=a(e.currentTarget),n=t.find('[data-role="yes-tag"]');n.hasClass("icon-select-active")}p.$pay_li.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.addClass("icon-select-active").removeClass("icon-select-no");var l=t.attr("data-pay-type");p.selected_pay_action_type=l,p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active"),p.can_use_balance&&p.$select_ab_btn.find('[data-role="yes-tag"]').addClass("icon-select-active")}),p.$left_btn.on("click",function(){p.$page_container.removeClass("fn-hide"),p.$coupon_list_wrap.addClass("fn-hide"),n.is_yue_app||a("main").css("padding-top","45px")}),p.$right_btn.on("click",function(){p.$page_container.removeClass("fn-hide"),p.$coupon_list_wrap.addClass("fn-hide");var t=p.coupon_obj.selected_coupon,l={can_use_balance:p.can_use_balance,available_balance:p.ab,total_price:p.total_price,set_pay_type:!1,coupon:t&&t.face_value};e.count_money(l),t&&p.$coupon_money_tag.html(t.batch_name),t?p.$coupon_money.find('[data-role="yes-tag"]').addClass("icon-select-active").removeClass("icon-select-no"):p.$coupon_money.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.is_yue_app||a("main").css("padding-top","45px")}),p.$coupon_money.on("click",function(){p.$page_container.addClass("fn-hide"),p.$coupon_list_wrap.removeClass("fn-hide"),n.is_yue_app||a("main").css("padding-top",0)}),p.$pay_btn.on("click",function(){if(!p.selected_pay_action_type)return void alert("请选择支付方式");if(confirm("确认支付?")){var n="./sign.php?event_id="+_page_params.result_data.event_id,o={third_code:p.selected_pay_action_type,redirect_url:n,coupon_sn:p.coupon_obj.selected_coupon&&p.coupon_obj.selected_coupon.coupon_sn||"",available_balance:p.ab,is_available_balance:p.$select_ab_btn.find('[data-role="yes-tag"]').hasClass("icon-select-active")?1:0};o=a.extend({},o,_page_params.result_data,!0),e.pay_action(o,{success:function(n){var o=n.result_data&&n.result_data.third_code,s=n.result_data&&n.result_data.channel_return,c=n.result_data&&n.result_data.code;if(2==c)switch(o){case"alipay_purse":i.alipay({alipayparams:n.result_data.data,payment_no:n.result_data.payment_no},function(n){var o=t.int(n.result),i=e.after_pay_text(o);a.tips({content:i,stayTime:3e3,type:"success"}),(1==o||-1==o||-2==o)&&(l.location.href=s)});break;case"tenpay_wxapp":i.wxpay(JSON.parse(n.result_data.data),function(n){var o=t.int(n.result),i=e.after_pay_text(o);a.tips({content:i,stayTime:3e3,type:"success"}),(1==o||-1==o||-2==o)&&(l.location.href=s)})}else a.tips({content:"余额支付成功",stayTime:3e3,type:"success"}),l.location.href=s},error:function(){}})}});var o={can_use_balance:p.ab>0?!0:!1,available_balance:p.ab,total_price:p.total_price};e.count_money(o)},count_money:function(e){var n=this,l=t.float(e.total_price),o=t.float(e.available_balance),i=null==e.set_pay_type?!0:!1,s=e.coupon||0,c=0;s&&(l-=t.float(s));var d=o-l;e.can_use_balance?(c=d,0>=c?c=o:(c=l,d=0),p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"),d>=0?(n.clear_select(),n.control_other_pay_item({show:!1}),console.log("余额完全够钱支付了订单")):(n.control_other_pay_item({show:!0}),i&&a('[data-pay-type="'+p.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"))):(d=l,n.clear_select(!0),n.control_other_pay_item({show:!0}),i&&a('[data-pay-type="'+p.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active")),n.must_pay_money=t.format_float(d,2),n.must_pay_money<0&&(n.must_pay_money=-1*n.must_pay_money),p.$need_price.html(n.must_pay_money),p.$less_money.html("-￥"+c),p.$coupon_money_text.html(s?"-￥"+s:"")},pay_action:function(e,n){var o=a.loading({content:"发送中..."}),i="join_again_act.php";t.ajax_request({url:l.$__ajax_domain+i,data:e,type:"POST",success:function(e){if(o.loading("hide"),e.result_data&&e.result_data.code>0){n.success.call(this,e);var t="success"}else{var t="warn";a.tips({content:e.result_data.message,stayTime:3e3,type:t})}},error:function(){n.error.call(this),o.loading("hide"),a.tips({content:"网络异常",stayTime:3e3,type:"warn"})}})},clear_select:function(a){var e=p.$pay_li.find('[data-role="yes-tag"]');a?p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"):e.removeClass("icon-select-active").addClass("icon-select-no")},control_other_pay_item:function(e){e.show?(a('[data-role="other-pay-container"]').removeClass("fn-hide"),a('[data-role="must-pay-container"]').removeClass("last-sec-container")):(a('[data-role="other-pay-container"]').addClass("fn-hide"),a('[data-role="must-pay-container"]').addClass("last-sec-container"))},after_pay_text:function(a){var e="";switch(t.int(a)){case 1:case-2:case-1:e="支付成功";break;case 0:e="其它错误";break;case-3:e="支付失败";break;case-4:e="支付取消"}return e}};var u=new _;u.refresh()}(l,window)});