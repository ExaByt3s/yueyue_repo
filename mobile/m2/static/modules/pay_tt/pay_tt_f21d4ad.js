define("pay_tt",function(a){"use strict";var e=a("common/widget/back_btn/main"),t=a("common/utility/index"),n=a("components/zepto/zepto.js"),o=a("components/fastclick/fastclick.js"),s=(a("yue_ui/frozen"),a("common/I_APP/I_APP")),l=a("coupon/list"),i=a("common/widget/yueyue_header/main");"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){o.attach(document.body)},!1),function(a,n){if(s.isPaiApp){var o=n.__YUE_APP_USER_INFO__,c=t.login_id,r=n.__YUE_APP_USER_INFO__.user_id||0,d=c==r;console.log("=====local_user_id,client_user_id====="),console.log(c,r),t.ajax_request({url:n.$__config.ajax_url.auth_get_user_info,data:o,cache:!1,async:d}),s.check_login(function(a){return t.int(a.pocoid)?void 0:void s.openloginpage(function(a){"0000"==a.code&&t.refresh_page()})})}var _=a("#nav-header"),u=Handlebars.template(function(a,e,t,n,o){this.compilerInfo=[4,">= 1.0.0"],t=this.merge(t,a.helpers),o=o||{};var s,l,i="",c="function",r=this.escapeExpression;return i+='<ul class="ui-list ui-list-text ui-border-b">\r\n	<li>\r\n		<div class="ui-avatar">\r\n		   <span style="background-image:url(\'',(l=t.user_icon)?s=l.call(e,{hash:{},data:o}):(l=e&&e.user_icon,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'\')"></span>\r\n		</div>\r\n		<div class="ui-list-info ui-border-t">\r\n			<h4>',(l=t.user_nickname)?s=l.call(e,{hash:{},data:o}):(l=e&&e.user_nickname,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+"</h4>\r\n			<p>服务类型 ",(l=t.service_name)?s=l.call(e,{hash:{},data:o}):(l=e&&e.service_name,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'</p>\r\n		</div>\r\n	</li>				\r\n</ul>\r\n<ul class="ui-list ui-list-text">\r\n	<li class="ui-border-t">\r\n		<div class="ui-txt-default ">支付类型：<span>',(l=t.pay_type)?s=l.call(e,{hash:{},data:o}):(l=e&&e.pay_type,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'</span></div>\r\n	</li>	\r\n	<li class="ui-border-t">\r\n		<div class="ui-txt-default ">报价金额：<span>￥',(l=t.total_amount)?s=l.call(e,{hash:{},data:o}):(l=e&&e.total_amount,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'</span></div>\r\n	</li>\r\n	<li class="ui-border-t">\r\n		<div class="ui-txt-default ">服务金：<span>￥<label data-role="pay-amount">',(l=t.pay_amount)?s=l.call(e,{hash:{},data:o}):(l=e&&e.pay_amount,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'</label></span></div>\r\n	</li>\r\n</ul>\r\n\r\n<!--支付模块-->\r\n<ul class="ui-list ui-list-text mt20 ">  \r\n	<li >\r\n		<div class="ui-txt-default ">钱包<span></span></div>\r\n	</li>\r\n    <li data-role="coupon-money">\r\n        <div class="ui-txt-default ">使用优惠券：<span><div class="ui-nowrap" style="width: 200px;" data-role="coupon-money-tag"></div></span></div>\r\n        <div class="ui-edge-right">\r\n            <span class="count-money-color" data-role="coupon-money-text"></span>\r\n            <i class="icon icon-select-no" data-role="yes-tag"></i>\r\n        </div>\r\n    </li>\r\n    <li data-role="select-available-balance">\r\n		<div class="ui-txt-default ">账户余额：<span>￥<label data-role="available_balance">',(l=t.available_balance)?s=l.call(e,{hash:{},data:o}):(l=e&&e.available_balance,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'</label></span></div>\r\n		<div class="ui-edge-right">\r\n			<span class="count-money-color" data-role="less-money"></span>\r\n			<i class="icon icon-select-no" data-role="yes-tag"></i>\r\n		</div>\r\n	</li>					\r\n</ul>\r\n<ul class="ui-list ui-list-text ui-border-b mt20" style="margin-bottom: 0;"  data-role="must-pay-container">\r\n	<li class="ui-border-t">\r\n		<div class="ui-txt-default ">还需支付：<span class="count-money-color">￥<label data-role="need-price">',(l=t.pay_amount)?s=l.call(e,{hash:{},data:o}):(l=e&&e.pay_amount,s=typeof l===c?l.call(e,{hash:{},data:o}):l),i+=r(s)+'</label></span></div>\r\n	</li>	\r\n</ul>\r\n<ul class="ui-list ui-list-text " data-role="other-pay-container">\r\n	<li class="ui-border-t" data-pay-type="alipay_purse" data-role="pay-li">\r\n		<div class="ui-txt-default ">\r\n			<div class="pay-type">\r\n				<i class="icon icon-zhifubao"></i>\r\n				<div class="ui-list-info ">\r\n					<h4 class="ui-nowrap" >支付宝支付</h4>\r\n					<p class="ui-nowrap">推荐有支付宝账号的用户使用</p>\r\n				</div>\r\n			</div>\r\n			<div class="ui-edge-right">\r\n				<i class="icon icon-select-no" data-role="yes-tag"></i>\r\n			</div>\r\n		</div>\r\n	</li>	\r\n	<li class="ui-border-t" data-pay-type="tenpay_wxapp" data-role="pay-li">\r\n		<div class="ui-txt-default ">\r\n			<div class="pay-type">\r\n				<i class="icon icon-wx-pay"></i>\r\n				<div class="ui-list-info ">\r\n					<h4 class="ui-nowrap" >微信支付</h4>\r\n					<p class="ui-nowrap">安装微信5.0及以上版本的使用</p>\r\n				</div>\r\n			</div>\r\n			<div class="ui-edge-right">\r\n				<i class="icon icon-select-no" data-role="yes-tag"></i>\r\n			</div>\r\n		</div>\r\n	</li>\r\n</ul>\r\n\r\n<div class="last-container"></div>\r\n<!--支付模块-->\r\n<div class="buttom-btn-wrap">\r\n	<button class="ui-tt-pay-btn" id="pay-btn">\r\n		确认支付\r\n	</button>\r\n</div>'}),p={};p.quotes_id=a("#quotes_id").val(),p.$page_container=a('[data-role="page-container"]'),s.isPaiApp&&s.analysis("moduletongji",{pid:"1220089",mid:"122OD04006"});var y=function(){var a=this;a.init()};y.prototype={refresh:function(){var e=this,o=a.loading({content:"加载中..."});t.ajax_request({url:n.$__config.ajax_url.get_tt_pay_info,data:{quotes_id:p.quotes_id},success:function(t){var n=t.result_data;p.$page_container.html(""),p.$page_container.html(u(n)),n.request_id&&(p.request_id=n.request_id),n.total_amount&&(p.order_total_amount=n.total_amount),n.pay_amount&&(p.order_pay_amount=n.pay_amount),p.coupon_obj=l.init({container:a('[data-role="coupon-list-container"]'),module_type:"task_request",request_id:p.request_id,quotes_id:p.quotes_id,order_total_amount:p.order_total_amount,order_pay_amount:p.order_pay_amount,page:1}),e.setup_event(),o.loading("hide")},error:function(){o.loading("hide"),a.tips({content:"网络异常",stayTime:3e3,type:"warn"})}})},page_back:function(){},init:function(){var a=this,t=e.render();_.prepend(t),a.setup_back()},hide:function(){},setup_back:function(){a('[data-role="page-back"]').on("tap",function(){s.isPaiApp&&s.app_back()})},setup_event:function(){var e=this;p.$pay_li=a('[data-role="pay-li"]'),p.$pay_btn=a("#pay-btn"),p.$select_ab_btn=a('[data-role="select-available-balance"]'),p.$less_money=a('[data-role="less-money"]'),p.$available_balance=a('[data-role="available_balance"]'),p.$need_price=a('[data-role="need-price"]'),p.ab=a('[data-role="available_balance"]').html(),p.total_price=a('[data-role="pay-amount"]').html(),p.$coupon_list_wrap=a('[data-role="coupon-list-wrap"]'),p.$coupon_money=a('[data-role="coupon-money"]'),p.$coupon_money_tag=a('[data-role="coupon-money-tag"]'),p.$coupon_money_text=a('[data-role="coupon-money-text"]'),i.render(a('[data-role="nav-header"]')[0],{left_text:"返回",title:"可用优惠券",right_text:"确定"}),p.$left_btn=a('[data-role="left-btn"]'),p.$right_btn=a('[data-role="right-btn"]'),p.selected_pay_action_type="alipay_purse",p.can_use_balance=!0,p.$select_ab_btn.on("click",function(t){var n=a(t.currentTarget),o=n.find('[data-role="yes-tag"]'),s=o.hasClass("icon-select-active");s?o.addClass("icon-select-no").removeClass("icon-select-active"):o.removeClass("icon-select-no").addClass("icon-select-active"),p.can_use_balance=o.hasClass("icon-select-active");var l={can_use_balance:p.can_use_balance,available_balance:p.ab,total_price:p.total_price,coupon:p.coupon_obj.selected_coupon&&p.coupon_obj.selected_coupon.face_value};e.count_money(l)}),p.$pay_li.on("click",function(e){{var t=a(e.currentTarget),n=t.find('[data-role="yes-tag"]');n.hasClass("icon-select-active")}p.$pay_li.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"),n.addClass("icon-select-active").removeClass("icon-select-no");var o=t.attr("data-pay-type");p.selected_pay_action_type=o,p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active"),p.can_use_balance&&p.$select_ab_btn.find('[data-role="yes-tag"]').addClass("icon-select-active")}),p.$left_btn.on("click",function(){p.$page_container.removeClass("fn-hide"),p.$coupon_list_wrap.addClass("fn-hide")}),p.$right_btn.on("click",function(){p.$page_container.removeClass("fn-hide"),p.$coupon_list_wrap.addClass("fn-hide");var a=p.coupon_obj.selected_coupon,t={can_use_balance:p.can_use_balance,available_balance:p.ab,total_price:p.total_price,set_pay_type:!1,coupon:a&&a.face_value};e.count_money(t),p.$coupon_money_tag.html(a.batch_name),a?p.$coupon_money.find('[data-role="yes-tag"]').addClass("icon-select-active").removeClass("icon-select-no"):p.$coupon_money.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no")}),p.$coupon_money.on("click",function(){p.$page_container.addClass("fn-hide"),p.$coupon_list_wrap.removeClass("fn-hide")}),p.$pay_btn.on("click",function(){if(s.analysis("eventtongji",{id:"1220090"}),!p.selected_pay_action_type)return void alert("请选择支付方式");if(confirm("确认支付?")){var o=n.location.href.replace("pay.php","pay_success.php"),l={third_code:p.selected_pay_action_type,quotes_id:p.quotes_id,redirect_url:o,coupon_sn:p.coupon_obj.selected_coupon&&p.coupon_obj.selected_coupon.coupon_sn||"",available_balance:p.ab,is_available_balance:p.$select_ab_btn.find('[data-role="yes-tag"]').hasClass("icon-select-active")?1:0};e.pay_action(l,{success:function(o){var l=o.result_data&&o.result_data.third_code,i="pay_success.php?"+o.result_data.payment_no,c=o.result_data&&o.result_data.result;if(1==c)switch(l){case"alipay_purse":s.alipay({alipayparams:o.result_data.request_data,payment_no:o.result_data.payment_no},function(o){var s=t.int(o.result),l=e.after_pay_text(s);a.tips({content:l,stayTime:3e3,type:"success"}),(1==s||-1==s||-2==s)&&(n.location.href=i)});break;case"tenpay_wxapp":s.wxpay(JSON.parse(o.result_data.request_data),function(o){var s=t.int(o.result),l=e.after_pay_text(s);a.tips({content:l,stayTime:3e3,type:"success"}),(1==s||-1==s||-2==s)&&(n.location.href=i)})}else a.tips({content:"余额支付成功",stayTime:3e3,type:"success"}),n.location.href=i},error:function(){}})}});var o={can_use_balance:p.ab>0?!0:!1,available_balance:p.ab,total_price:p.total_price};e.count_money(o)},count_money:function(e){var n=this,o=t.float(e.total_price),s=t.float(e.available_balance),l=null==e.set_pay_type?!0:!1,i=e.coupon||0,c=0;i&&(o-=t.float(i));var r=s-o;e.can_use_balance?(c=r,0>=c?c=s:(c=o,r=0),p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"),r>=0?(n.clear_select(),n.control_other_pay_item({show:!1}),console.log("余额完全够钱支付了订单")):(n.control_other_pay_item({show:!0}),l&&a('[data-pay-type="'+p.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active"))):(r=o,n.clear_select(!0),n.control_other_pay_item({show:!0}),l&&a('[data-pay-type="'+p.selected_pay_action_type+'"]').find('[data-role="yes-tag"]').removeClass("icon-select-no").addClass("icon-select-active")),n.must_pay_money=t.format_float(r,2),n.must_pay_money<0&&(n.must_pay_money=-1*n.must_pay_money),p.$need_price.html(n.must_pay_money),p.$less_money.html("-￥"+c),p.$coupon_money_text.html(i?"-￥"+i:"")},pay_action:function(e,o){var s=a.loading({content:"发送中..."});t.ajax_request({url:n.$__config.ajax_url.pay_tt_action,data:e,type:"POST",success:function(e){if(s.loading("hide"),e.result_data&&e.result_data.result>0){o.success.call(this,e);var t="success"}else{var t="warn";a.tips({content:e.result_data.message,stayTime:3e3,type:t})}},error:function(){o.error.call(this),s.loading("hide"),a.tips({content:"网络异常",stayTime:3e3,type:"warn"})}})},clear_select:function(a){var e=p.$pay_li.find('[data-role="yes-tag"]');a?p.$select_ab_btn.find('[data-role="yes-tag"]').removeClass("icon-select-active").addClass("icon-select-no"):e.removeClass("icon-select-active").addClass("icon-select-no")},control_other_pay_item:function(e){e.show?(a('[data-role="other-pay-container"]').removeClass("fn-hide"),a('[data-role="must-pay-container"]').removeClass("last-sec-container")):(a('[data-role="other-pay-container"]').addClass("fn-hide"),a('[data-role="must-pay-container"]').addClass("last-sec-container"))},after_pay_text:function(a){var e="";switch(t.int(a)){case 1:case-2:case-1:e="支付成功";break;case 0:e="其它错误";break;case-3:e="支付失败";break;case-4:e="支付取消"}return e}};var v=new y;v.refresh()}(n,window)});